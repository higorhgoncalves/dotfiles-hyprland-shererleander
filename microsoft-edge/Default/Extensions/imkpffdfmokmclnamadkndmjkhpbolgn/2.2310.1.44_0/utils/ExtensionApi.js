let bookingFlag=!0;function responseBuilder(e,t,a){t(a).then((t=>{e({res:t,requestId:a.requestId})}))}helpers.ExtensionApi=class ExtensionApi{async getTranslation(e){return await helpers.Utils.translate(e)}async getCookie(e,t){let a=await chrome.cookies.get({url:t,name:e});return await a.value}async getLoggedUser(){return helpers.Api.getLoggedUser()}async getWidgetPreferences(){let e=await chrome.storage.local.get(["widgetPreferences"]);return void 0===e.widgetPreferences&&(e.widgetPreferences={}),e.widgetPreferences}async setWidgetPreferences(e){let t=await helpers.ExtensionApi.getWidgetPreferences();return t={...t,...e.payload},chrome.storage.local.set({widgetPreferences:t}),t}async getAppName(){return APP_NAME}async hideWidget(e){let t=await helpers.Utils.getRetailerFromUrl(e.url);return await helpers.Utils.hideWidgetByRetailerId(t.id)}async activatedCashbackSeen(e){let t=await helpers.Utils.getRetailerFromUrl(e.url);return await helpers.Utils.activatedCashbackSeen(t.id)}async minifyWidget(e){let t=await helpers.Utils.getRetailerFromUrl(e.url),a=await helpers.Utils.minifyWidgetByRetailerId(t.id,e.state);return e.refreshAll&&await helpers.ExtensionApi.refreshAllRetailersWidgets(e),a}async getStartConfig(e){let t=e.tab,a=await helpers.Utils.getRetailerFromUrl(await t.url),i=await chrome.storage.local.get(["devLogsToggleStatus"]);return helpers.Api.getCrps(),{isCashbackActivated:await helpers.ExtensionApi.isCashbackActivated(t),isCouponCashbackActivated:await helpers.Utils.isCouponCashbackActivated(await(a?.id)),webSiteHasCashback:await helpers.ExtensionApi.webSiteHasCashback(t),retailer:await a,devLogsEnabled:i.devLogsToggleStatus??!1,isMinifiedRetailer:await helpers.Utils.isMinifiedRetailer(await(a?.id)),dictionary:await helpers.ExtensionApi.getDictionary(),config:await helpers.ExtensionApi.getConfig(),extUrl:await chrome.runtime.getURL(""),allRetailers:await helpers.Api.getRetailersList(),user:await helpers.ExtensionApi.getLoggedUser(),crps:await helpers.Api.getCrps(),all_exts:await helpers.ExtensionApi.getAllExtentions()}}async getAllExtentions(){return chrome.management.getAll()}async getCoupons(e){let t=await helpers.Utils.getRetailerFromUrl(e.tab.url);return null==t?[]:await helpers.Api.getCouponForRetailer(t.id)}buildApiUrl(e){let t="";for(let a in e)t+=`&${a}=${e[a]}`;return BASE_URL+API_PATH+"?"+t}async couponNinjaGoShop(e){let t=BASE_URL+e.retailer.url+"?sa=brext&quick=1&a="+e.retailer.id;await chrome.tabs.create({url:t,active:!1,index:0,pinned:!0});return await chrome.tabs.onUpdated.addListener((async function listener(a,i,r){a==r.id&&"complete"==i.status&&setTimeout((async()=>{await chrome.tabs.onUpdated.removeListener(listener),await chrome.tabs.remove(r.id),console.log("URL",t),await helpers.Utils.minifyWidgetByRetailerId(e.retailer.id,!1),await helpers.Utils.activateCouponCashback(e.retailer.id)}),2e3)})),{}}async yoNinja(){if(bookingFlag){let e="https://www.cashyo.co.il/hooks/goshop/booking.php?mode=quick&a="+APP_NAME,t=await chrome.tabs.create({url:e,active:!1,index:0,pinned:!0});async function listener(e,a,i){console.log([e,a,i]),e==t.id&&"complete"==a.status&&setTimeout((async()=>{await chrome.tabs.onUpdated.removeListener(listener),await chrome.tabs.remove(i.id)}),2e3)}return await chrome.tabs.onUpdated.addListener(listener),bookingFlag=!1,setTimeout((()=>{bookingFlag=!0}),12e4),{}}}async snitchNoLog(e){await helpers.Api.snitchNoLog(e.message)}async getDictionary(e){return await helpers.Utils.getDictionary()}async getConfig(e){return await helpers.Utils.getExtConfig()}async isCashbackActivated(e=null){let t=e||await helpers.Utils.getCurrentTab(),a=await helpers.Utils.getRetailerFromUrl(t.url);return void 0!==a&&null!=a&&(void 0!==a.cashbackActivatedUntil&&a.cashbackActivatedUntil>Date.now())}async webSiteHasCashback(e){return await helpers.Utils.websiteHasCashback(e)}async refreshAllWidgets(e,t=!1){let a=await chrome.tabs.query({});for(let i=0;i<a.length;i++)try{if(t&&a[i].id==e.tab.id)continue;let r=await chrome.tabs.sendMessage(a[i].id,{action:"isWidgetInjected"});r&&r.res&&(await helpers.Injection.injectCloseWidget(a[i]),await helpers.Injection.injectFromIcon(a[i]))}catch{}return 1}async refreshAllRetailersWidgets(e){let t=await chrome.tabs.query({}),a=await helpers.Utils.getRetailerFromUrl(e.url);if(a){for(let i=0;i<t.length;i++)try{let r=await helpers.Utils.getRetailerFromUrl(t[i].url);if(!r)continue;if(a.id!=r.id)continue;if(e.exceptRequestPage&&e.exceptRequestPage&&t[i].id==e.tab.id)continue;let s=await chrome.tabs.sendMessage(t[i].id,{action:"isWidgetInjected"});s&&s.res&&(await helpers.Injection.injectCloseWidget(t[i]),await helpers.Injection.injectFromIcon(t[i]))}catch(e){console.log(e,e.stack)}return 1}}async refreshAllWidgetsByPattern(e){let t=await chrome.tabs.query({});for(let a=0;a<t.length;a++)try{if(!await helpers.Utils.getRetailerFromUrl(t[a].url))continue;if(!new RegExp(e).test(t[a].url))continue;let i=await chrome.tabs.sendMessage(t[a].id,{action:"isWidgetInjected"});i&&i.res&&(await helpers.Injection.injectCloseWidget(t[a]),await helpers.Injection.injectFromIcon(t[a]))}catch(e){console.log(e,e.stack)}return 1}async activateCashbackFromRetailerId(e){return{success:await helpers.Utils.activateCashbackFromRetailerId(e.retailerId)}}async onOffExtention(e){return chrome.management.setEnabled(e.ext_id,e.state,(()=>{})),{req:e}}async doYouExist(){return{success:!0}}async navigate(e){console.log(e),chrome.tabs.update(e.tab.id,{url:e.url})}async getShopRecommendations(e){return helpers.Utils.getShopRecommendations()}async addShopRecommendations(e){return helpers.Utils.addShopRecommendations(e.url)}},chrome.runtime.onMessage.addListener(((e,t,a)=>("getAppName"===e.action&&responseBuilder(a,helpers.ExtensionApi.getAppName,e),e.appName!=APP_NAME&&e.appName!=APP_NAME+"_website"||(e.tab=t.tab,responseBuilder(a,helpers.ExtensionApi[e.action],e)),!0)));